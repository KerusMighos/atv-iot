# Atividade

Implementa√ß√£o e Avalia√ß√£o de Comunica√ß√£o IoT com M√∫ltiplos Protocolos

# Turma

SAJ-OPC16 - T√≥picos Avan√ßados em Web I 
2025.1

# Equipe

Ant√¥nio Salgueiro
Adriano Victor
Filipe Ribeiro

# Cenario: Estufa automatizada

O cenario desenvolvido, comforme sugerido foi o de uma estufa automatizada.

# Estrutura

![Estrutura](imagens/Estrutura.png)


# Sensores

Os sensores simulados foram os de luminosidade, temperatura e umidade do solo.

# Atuadores

Tambem foi simulado um atuador, um exaustor que tem como objetivo diminuir a temperatura da estufa 

# Logica de decis√£o

A logica de decis√£o foi implementada dentro do Node Red usando um Function Node:

(Observe que o node red s√≥ envia o comando de altera√ß√£o de potencia quando a potencia desejada muda)

```
var new_potencia = 0;

var sensor_read = msg.payload.valor

if(sensor_read > 35){
    new_potencia = 90
} else if (sensor_read > 25) {
    new_potencia = 50
} else if (sensor_read > 20) {
    new_potencia = 10
} else {
    new_potencia = 0
}

var old_potencia = context.get("old_potencia")

if( old_potencia == new_potencia) {
    node.log(`üìå Mantendo potencia de ${old_potencia}%`);
    return;
}

node.log(`‚ôªÔ∏è Atualizando potencia para ${new_potencia}`);
context.set("old_potencia", new_potencia)
return {payload:{potencia: new_potencia}};
```

# Protocolos utilizados

## Mqtt Mosquitto

Foi implementado na comunica√ß√£o entre os sensores e o Node Red

### Seguran√ßa

Foi implementada TLS tanto para criptografia quanto para autentica√ß√£o, sendo necessario que os clients do broker apresentem certificados validos.

## Amqp RabbitMQ

Foi implementado na comunica√ß√£o entre o Node Red e o atuador

### Seguran√ßa

Foi utilizada a autentica√ß√£o atrav√©s de usuario e senha

## Compara√ß√£o

| Caracter√≠stica            | MQTT (Mosquitto)                                 | AMQP (RabbitMQ)                                      |
| ------------------------- | ------------------------------------------------ | ---------------------------------------------------- |
| **Modelo de Mensagem**    | Publish/Subscribe (Pub/Sub)                      | Message Queue (Fila) com roteamento avan√ßado         |
| **Padr√£o**                | Leve, ideal para IoT                             | Mais robusto, corporativo                            |
| **Entrega de Mensagens**  | Best effort + QoS (0, 1, 2)                      | Garantida com confirma√ß√£o (ACK) e filas persistentes |
| **Persist√™ncia**          | Opcional, geralmente vol√°til                     | Fila persistente por padr√£o                          |
| **Seguran√ßa**             | TLS com certificados (mutual TLS implementado)   | Login/senha (mais simples, direto)                   |
| **Overhead de Protocolo** | Muito baixo (ideal para dispositivos embarcados) | Mais pesado, maior consumo de rede e CPU             |
| **Roteamento**            | Simples: baseado em t√≥picos                      | Complexo: t√≥picos, direct, fanout, headers           |
| **Casos de Uso**          | Comunica√ß√£o r√°pida entre sensores (telemetria)   | Orquestra√ß√£o de comandos para atuadores              |
| **Confiabilidade**        | M√©dia, dependendo do QoS                         | Alta, mensagens garantidas at√© serem processadas     |

| Protocolo | Uso no Projeto                                 | Justificativa                                                                                                                                                             |
| --------- | ---------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **MQTT**  | Comunica√ß√£o entre **sensores** e **Node-RED**  | Leve, eficiente, baixo overhead, ideal para dados peri√≥dicos de sensores. Al√©m disso, suporta milhares de conex√µes simult√¢neas com m√≠nimo uso de banda e CPU.             |
| **AMQP**  | Comunica√ß√£o entre **Node-RED** e **atuadores** | Oferece garantia de entrega, filas robustas, roteamento avan√ßado e controle mais rigoroso, essencial quando um comando (ex.: "Ativar exaustor") **n√£o pode ser perdido**. |

# Monitoramento

A simula√ß√£o foi desenvolvida para ser implantada usando docker compose, sendo possivel monitorala diretamente atrav√©s dos logs do compose up

Tambem √© possivel realizar o monitoramento atrav√©s do dashboard de debug do Node Red

![Logs no console](imagens/LogConsole.png)

# Bugs e Problemas

### Problema com permiss√µes

Programas em um container por padr√£o rodam como root

O normal no linux geralmente √© o 1000

A imagem do broker Mosquitto roda internamente no usuario 1883

Isso causou alguns problemas durante o desenvolvimento que foram resolvidos dando permiss√£o de leitura de pelo menos chmod 111

### Implantar no Node Red

Ap√≥s adicionarmos a biblioteca de terceiros @stormpass/node-red-contrib-amqp para termos suporte a AMQP, o node red passou a crashar sempre que implantamos, apesar da mensagem no painel web que a implata√ß√£o falhou, ela ocorre normamente o docker reinicia o node red

### RabbitMQ

O rabbit mq demora bastante para iniciar, e mesmo tentando configurar o healtcheck do docker para ele, outros servi√ßos ainda inicializam e reportam erros de conex√£o com ele, m√°s ap√≥s ele terminar de inicializar tudo se ajusta.

# Conclus√£o

Levando em conta nossa experiencia com a materia de Sistemas Distribuidos ministrada pelo mesmo professor, onde desenvolvemos diversas aplica√ß√µes utilizando tecnicas de comunica√ß√£o de baixo nivel, a eficiencia dos protocolos de iot demonstrou ser imensamente mais simles e robusta, visto que o protocolo j√° nos fornece de maneira robusta funcionalidades como confirma√ß√£o de entrega, redundancia, escalabilidade dentre outras de maneira buildin, nos permitindo nos preocupar somente com a logica de negocios real da aplica√ß√£o.

Sobre o Node Red, foi a nossa primeira experiencia com um ferramenta low-code, e foi muito agradavel, principalmente o fato de nos permitir editar o comportamento e implantar a nova vers√£o diretamente do navegador, sem termos que reiniciar todos os servi√ßos.

